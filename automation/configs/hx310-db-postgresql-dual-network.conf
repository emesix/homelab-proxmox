# PostgreSQL LXC Configuration for HX310-DB (breintrein)
# DUAL NETWORK: Backend + Management
# Deploy on: pve-hx310-db (192.168.10.12 staging)
# Service: pg-brein (datakluizenaar)

# Container Identity
export var_ctid="100"
export var_hostname="pg-brein"

# Resource Allocation
export var_cpu="2"
export var_ram="8192"
export var_disk="100"

# Storage
export var_storage="local-lvm"

# Container Type
export var_unprivileged="1"

# OS Configuration
export var_os="debian"
export var_version="12"

# PRIMARY NETWORK - Backend Database VLAN (VLAN 110)
# This is where services connect to PostgreSQL
# Staging: 192.168.10.20 (temporary)
# Production: 10.10.110.20/24 on VLAN 110
export var_brg="vmbr0"
export var_net="ip=192.168.10.20/16,gw=192.168.10.1"

# FUTURE PRODUCTION NETWORK CONFIG (commented for staging):
# export var_net="ip=10.10.110.20/24,gw=10.10.110.1"
# VLAN tag will be applied in Proxmox web UI or via post-deployment

# SSH Access
export var_ssh="yes"

# Advanced Options
export var_verbose="no"
export var_tags="database;postgresql;tier0;backend;vlan110;breintrein"

# IMPORTANT: DUAL NETWORK CONFIGURATION
# The community scripts only support single network interface via var_net
# To add a second network interface for management:
#
# AFTER DEPLOYMENT, manually add second interface:
# 1. In Proxmox web UI: Container > Network > Add
#    - Bridge: vmbr0
#    - VLAN Tag: 200 (Management VLAN)
#    - IP: 10.10.200.100/24 (static)
#    - Gateway: (leave empty, default already on VLAN 110)
#
# 2. Or via CLI after container creation:
#    pct set 100 -net1 name=eth1,bridge=vmbr0,tag=200,firewall=1,ip=10.10.200.100/24
#
# 3. Inside container, configure /etc/network/interfaces:
#    auto eth1
#    iface eth1 inet static
#        address 10.10.200.100/24
#
# Network Design:
# - eth0 (VLAN 110): 10.10.110.20 - Backend database network
#   - Services (Vaultwarden, Gitea, Wiki.js) connect here
#   - No direct user access
#   - Firewall rules allow only backend services
#
# - eth1 (VLAN 200): 10.10.200.100 - Management network
#   - SSH access for administration
#   - Monitoring agents
#   - Backup connections
#   - pgAdmin or database management tools

# PostgreSQL Configuration:
# - listen_addresses = '*' (but pg_hba.conf restricts by network)
# - Allow connections from:
#   - VLAN 110 (backend services): scram-sha-256
#   - VLAN 200 (management tools): scram-sha-256
#   - Local unix socket: peer
#
# pg_hba.conf rules:
# # Backend services (VLAN 110)
# host    all    all    10.10.110.0/24    scram-sha-256
#
# # Management network (VLAN 200)  
# host    all    all    10.10.200.0/24    scram-sha-256
#
# # Deny everything else
# host    all    all    0.0.0.0/0         reject

# Post-deployment:
# 1. Add second network interface (management)
# 2. Create databases: vaultwarden, gitea, wikijs
# 3. Create service users with restricted access
# 4. Configure pg_hba.conf for network-based ACLs
# 5. Test connectivity from VLAN 110 and VLAN 200
# 6. Block access from other VLANs via OPNsense firewall
